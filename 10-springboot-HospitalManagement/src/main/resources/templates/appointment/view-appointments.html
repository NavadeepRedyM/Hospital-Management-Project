<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Appointments Management | Admin</title>
    <!-- Standard FontAwesome CDN for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com">
    
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background-color: #f4f6f8; padding: 30px; }
        h2 { color: #2c3e50; margin-bottom: 20px; border-left: 5px solid #0077b6; padding-left: 15px; }
        .back-link { display: inline-block; margin-bottom: 15px; text-decoration: none; color: #2c3e50; font-weight: bold; }
        .back-link:hover { color: #0077b6; }
        
        /* Filter Styles */
        .filter-section { 
            background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; gap: 20px; align-items: flex-end;
        }
        .filter-group { display: flex; flex-direction: column; gap: 5px; }
        .filter-group label { font-size: 13px; font-weight: 600; color: #555; }
        .filter-group input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; outline: none; }
        .btn-reset { padding: 8px 15px; background: #95a5a6; color: white; border: none; border-radius: 4px; cursor: pointer; }

        table { width: 100%; border-collapse: collapse; background: white; box-shadow: 0 4px 8px rgba(0,0,0,0.05); border-radius: 8px; overflow: hidden; }
        th, td { padding: 14px; text-align: center; border: 1px solid #eee; vertical-align: middle; }
        th { background-color: #2c3e50; color: white; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        tr:hover { background-color: #f1f4f9; }
        
        .status-pending { color: #f39c12; font-weight: bold; }
        .status-confirmed { color: #27ae60; font-weight: bold; }
        .fee-text { color: #0077b6; font-weight: 600; }
        
        /* Button Styles */
        .btn-assign { background-color: #0077b6; color: white; padding: 7px 14px; text-decoration: none; border-radius: 4px; font-size: 13px; transition: 0.3s; display: inline-block; }
        .btn-assign:hover { background-color: #023e8a; }
        .btn-reassign { background-color: #f39c12; color: white; padding: 7px 14px; text-decoration: none; border-radius: 4px; font-size: 13px; display: inline-block; margin-bottom: 8px; transition: 0.3s; width: 110px; }
        .btn-reassign:hover { background-color: #d68910; }
        .btn-cancel { background: none; border: none; color: #c0392b; cursor: pointer; font-size: 13px; padding: 0; font-weight: bold; transition: 0.3s; }
        .btn-cancel:hover { color: #922b21; text-decoration: underline; }
        
        .text-completed { color: #34495e; font-weight: 600; font-size: 13px; display: inline-flex; align-items: center; gap: 4px; }
        .action-wrapper { display: flex; flex-direction: column; align-items: center; gap: 5px; }
    </style>
</head>
<body>

<a th:href="@{/admin/dashboard}" class="back-link">← Back to Admin Dashboard</a>

<h2>Appointments Management</h2>

<!-- Filter Section -->
<div class="filter-section">
    <div class="filter-group">
        <label><i class="fas fa-calendar-day"></i> Filter by Date</label>
        <input type="date" id="dateFilter" onchange="applyFilters()">
    </div>
    <div class="filter-group">
        <label><i class="fas fa-search"></i> Search Name/ID</label>
        <input type="text" id="nameFilter" placeholder="Search..." onkeyup="applyFilters()">
    </div>
    <button class="btn-reset" onclick="resetFilters()">Reset</button>
</div>

<table id="appointmentTable">
    <thead>
        <tr>
            <th>ID</th>
            <th>Patient ID</th>
            <th>Department</th>
            <th>Fee</th>
            <th>Doctor Name</th>
            <th>Date & Time</th>
            <th>Status</th>
            <th>Assign</th>
            <th>Reassign & Actions</th>
        </tr>
    </thead>
    <tbody>
        <tr th:each="a : ${appointments}" class="appointment-row">
            <td th:text="${a.id}"></td>
            <td th:text="${a.patient != null ? a.patient.id : 'N/A'}" class="patient-id"></td>
            <td th:text="${a.department != null ? a.department.deptName : 'N/A'}"></td>
            <td class="fee-text" th:text="${a.department != null ? '₹ ' + a.department.consultationFee : '₹ 0.0'}"></td>
            <td th:text="${a.doctor != null ? 'Dr. ' + a.doctor.name : 'Unassigned'}" class="doctor-name"></td>
            <td>
                <!-- Important: We use data-date attribute to store raw YYYY-MM-DD for JS comparison -->
                <span th:text="${a.appointmentDate != null ? #temporals.format(a.appointmentDate, 'dd-MM-yyyy') : 'N/A'}" 
                      th:attr="data-date=${a.appointmentDate}" 
                      class="appt-date-cell"></span><br/>
                <small class="text-muted" th:text="${a.timeSlot}"></small>
            </td>
            <td th:class="${a.status == 'CONFIRMED' ? 'status-confirmed' : 'status-pending'}" 
                th:text="${a.status}"></td>
            
            <td>
                <a th:if="${a.doctor == null}" th:href="@{/appointments/assign/{id}(id=${a.id})}" class="btn-assign">
                   <i class="fas fa-user-plus"></i> Assign
                </a>
                <span th:if="${a.doctor != null}" class="text-completed">
                    <i class="fas fa-check-circle"></i> Completed
                </span>
            </td>

            <td>
                <div class="action-wrapper">
                    <a th:if="${a.doctor != null}" th:href="@{/appointments/reassign/{id}(id=${a.id})}" class="btn-reassign">
                       <i class="fas fa-arrows-rotate"></i> Reassign
                    </a>
                    <form th:action="@{/appointments/cancel/{id}(id=${a.id})}" method="post">
                    <input type="hidden" name="_method" value="PUT" />
                        <button type="submit" class="btn-cancel">
                            <i class="fas fa-ban"></i> Cancel
                        </button>
                    </form>
                </div>
            </td>
        </tr>
    </tbody>
</table>

<script>
    function applyFilters() {
        const dateInput = document.getElementById('dateFilter').value; // Format: YYYY-MM-DD
        const nameInput = document.getElementById('nameFilter').value.toLowerCase();
        const rows = document.querySelectorAll('.appointment-row');

        rows.forEach(row => {
            const dateCell = row.querySelector('.appt-date-cell').getAttribute('data-date'); // YYYY-MM-DD
            const textContent = row.innerText.toLowerCase();
            
            let dateMatch = true;
            let nameMatch = true;

            // Date filtering
            if (dateInput && dateCell !== dateInput) {
                dateMatch = false;
            }

            // Name/Text filtering
            if (nameInput && !textContent.includes(nameInput)) {
                nameMatch = false;
            }

            if (dateMatch && nameMatch) {
                row.style.display = "";
            } else {
                row.style.display = "none";
            }
        });
    }

    function resetFilters() {
        document.getElementById('dateFilter').value = "";
        document.getElementById('nameFilter').value = "";
        applyFilters();
    }
</script>

</body>
</html>
